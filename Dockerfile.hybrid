# Dockerfile híbrido - Frontend + Backend
FROM node:18-alpine as build

# Establecer directorio de trabajo
WORKDIR /app

# Copiar archivos de dependencias
COPY package*.json ./

# Instalar dependencias
RUN npm install

# Copiar código fuente
COPY . .

# Construir la aplicación frontend
RUN npm run build

# Etapa de producción
FROM node:18-alpine

# Instalar nginx
RUN apk add --no-cache nginx

# Establecer directorio de trabajo
WORKDIR /app

# Copiar dependencias de backend
COPY package*.json ./
RUN npm ci --only=production

# Copiar servidor simple
COPY simple-server.js ./

# Copiar build del frontend
COPY --from=build /app/dist ./dist

# Configurar nginx
RUN mkdir -p /var/log/nginx /var/lib/nginx/tmp
COPY nginx/nginx.conf /etc/nginx/nginx.conf

# Script de inicio
RUN echo '#!/bin/sh' > /start.sh && \
    echo 'nginx &' >> /start.sh && \
    echo 'node simple-server.js &' >> /start.sh && \
    echo 'wait' >> /start.sh && \
    chmod +x /start.sh

# Exponer puerto 8080
EXPOSE 8080

# Variables de entorno
ENV NODE_ENV=production
ENV PORT=8080

# Comando para iniciar ambos servicios
CMD ["/start.sh"] 